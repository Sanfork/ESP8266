/*
 * oled.c
 *
 *  Created on: 2016Äê12ÔÂ23ÈÕ
 *      Author: fxsl01455
 */

#include "espressif/c_types.h"
#include "espressif/esp8266/eagle_soc.h"
#include "espressif/esp8266/gpio_register.h"
#include "freertos/portmacro.h"
#include "driver/oled.h"
#include "driver/gpio.h"


uint8 OLED_GRAM[128][8];
LOCAL uint8 m_nLastSDA;
LOCAL uint8 m_nLastSCL;

//=====================================Font.h============================
const uint8  asc2_1608[95][16] ={
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*" ",0*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xCC,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00},/*"!",1*/
{0x00,0x00,0x08,0x00,0x30,0x00,0x60,0x00,0x08,0x00,0x30,0x00,0x60,0x00,0x00,0x00},/*""",2*/
{0x02,0x20,0x03,0xFC,0x1E,0x20,0x02,0x20,0x03,0xFC,0x1E,0x20,0x02,0x20,0x00,0x00},/*"#",3*/
{0x00,0x00,0x0E,0x18,0x11,0x04,0x3F,0xFF,0x10,0x84,0x0C,0x78,0x00,0x00,0x00,0x00},/*"$",4*/
{0x0F,0x00,0x10,0x84,0x0F,0x38,0x00,0xC0,0x07,0x78,0x18,0x84,0x00,0x78,0x00,0x00},/*"%",5*/
{0x00,0x78,0x0F,0x84,0x10,0xC4,0x11,0x24,0x0E,0x98,0x00,0xE4,0x00,0x84,0x00,0x08},/*"&",6*/
{0x08,0x00,0x68,0x00,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"",7*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x18,0x18,0x20,0x04,0x40,0x02,0x00,0x00},/*"(",8*/
{0x00,0x00,0x40,0x02,0x20,0x04,0x18,0x18,0x07,0xE0,0x00,0x00,0x00,0x00,0x00,0x00},/*")",9*/
{0x02,0x40,0x02,0x40,0x01,0x80,0x0F,0xF0,0x01,0x80,0x02,0x40,0x02,0x40,0x00,0x00},/*"*",10*/
{0x00,0x80,0x00,0x80,0x00,0x80,0x0F,0xF8,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x00},/*"+",11*/
{0x00,0x01,0x00,0x0D,0x00,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*",",12*/
{0x00,0x00,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80},/*"-",13*/
{0x00,0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*".",14*/
{0x00,0x00,0x00,0x06,0x00,0x18,0x00,0x60,0x01,0x80,0x06,0x00,0x18,0x00,0x20,0x00},/*"/",15*/
{0x00,0x00,0x07,0xF0,0x08,0x08,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"0",16*/
{0x00,0x00,0x08,0x04,0x08,0x04,0x1F,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"1",17*/
{0x00,0x00,0x0E,0x0C,0x10,0x14,0x10,0x24,0x10,0x44,0x11,0x84,0x0E,0x0C,0x00,0x00},/*"2",18*/
{0x00,0x00,0x0C,0x18,0x10,0x04,0x11,0x04,0x11,0x04,0x12,0x88,0x0C,0x70,0x00,0x00},/*"3",19*/
{0x00,0x00,0x00,0xE0,0x03,0x20,0x04,0x24,0x08,0x24,0x1F,0xFC,0x00,0x24,0x00,0x00},/*"4",20*/
{0x00,0x00,0x1F,0x98,0x10,0x84,0x11,0x04,0x11,0x04,0x10,0x88,0x10,0x70,0x00,0x00},/*"5",21*/
{0x00,0x00,0x07,0xF0,0x08,0x88,0x11,0x04,0x11,0x04,0x18,0x88,0x00,0x70,0x00,0x00},/*"6",22*/
{0x00,0x00,0x1C,0x00,0x10,0x00,0x10,0xFC,0x13,0x00,0x1C,0x00,0x10,0x00,0x00,0x00},/*"7",23*/
{0x00,0x00,0x0E,0x38,0x11,0x44,0x10,0x84,0x10,0x84,0x11,0x44,0x0E,0x38,0x00,0x00},/*"8",24*/
{0x00,0x00,0x07,0x00,0x08,0x8C,0x10,0x44,0x10,0x44,0x08,0x88,0x07,0xF0,0x00,0x00},/*"9",25*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x0C,0x03,0x0C,0x00,0x00,0x00,0x00,0x00,0x00},/*":",26*/
{0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*";",27*/
{0x00,0x00,0x00,0x80,0x01,0x40,0x02,0x20,0x04,0x10,0x08,0x08,0x10,0x04,0x00,0x00},/*"<",28*/
{0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x00,0x00},/*"=",29*/
{0x00,0x00,0x10,0x04,0x08,0x08,0x04,0x10,0x02,0x20,0x01,0x40,0x00,0x80,0x00,0x00},/*">",30*/
{0x00,0x00,0x0E,0x00,0x12,0x00,0x10,0x0C,0x10,0x6C,0x10,0x80,0x0F,0x00,0x00,0x00},/*"?",31*/
{0x03,0xE0,0x0C,0x18,0x13,0xE4,0x14,0x24,0x17,0xC4,0x08,0x28,0x07,0xD0,0x00,0x00},/*"@",32*/
{0x00,0x04,0x00,0x3C,0x03,0xC4,0x1C,0x40,0x07,0x40,0x00,0xE4,0x00,0x1C,0x00,0x04},/*"A",33*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x04,0x11,0x04,0x0E,0x88,0x00,0x70,0x00,0x00},/*"B",34*/
{0x03,0xE0,0x0C,0x18,0x10,0x04,0x10,0x04,0x10,0x04,0x10,0x08,0x1C,0x10,0x00,0x00},/*"C",35*/
{0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"D",36*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x04,0x17,0xC4,0x10,0x04,0x08,0x18,0x00,0x00},/*"E",37*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x00,0x17,0xC0,0x10,0x00,0x08,0x00,0x00,0x00},/*"F",38*/
{0x03,0xE0,0x0C,0x18,0x10,0x04,0x10,0x04,0x10,0x44,0x1C,0x78,0x00,0x40,0x00,0x00},/*"G",39*/
{0x10,0x04,0x1F,0xFC,0x10,0x84,0x00,0x80,0x00,0x80,0x10,0x84,0x1F,0xFC,0x10,0x04},/*"H",40*/
{0x00,0x00,0x10,0x04,0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x04,0x00,0x00,0x00,0x00},/*"I",41*/
{0x00,0x03,0x00,0x01,0x10,0x01,0x10,0x01,0x1F,0xFE,0x10,0x00,0x10,0x00,0x00,0x00},/*"J",42*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x03,0x80,0x14,0x64,0x18,0x1C,0x10,0x04,0x00,0x00},/*"K",43*/
{0x10,0x04,0x1F,0xFC,0x10,0x04,0x00,0x04,0x00,0x04,0x00,0x04,0x00,0x0C,0x00,0x00},/*"L",44*/
{0x10,0x04,0x1F,0xFC,0x1F,0x00,0x00,0xFC,0x1F,0x00,0x1F,0xFC,0x10,0x04,0x00,0x00},/*"M",45*/
{0x10,0x04,0x1F,0xFC,0x0C,0x04,0x03,0x00,0x00,0xE0,0x10,0x18,0x1F,0xFC,0x10,0x00},/*"N",46*/
{0x07,0xF0,0x08,0x08,0x10,0x04,0x10,0x04,0x10,0x04,0x08,0x08,0x07,0xF0,0x00,0x00},/*"O",47*/
{0x10,0x04,0x1F,0xFC,0x10,0x84,0x10,0x80,0x10,0x80,0x10,0x80,0x0F,0x00,0x00,0x00},/*"P",48*/
{0x07,0xF0,0x08,0x18,0x10,0x24,0x10,0x24,0x10,0x1C,0x08,0x0A,0x07,0xF2,0x00,0x00},/*"Q",49*/
{0x10,0x04,0x1F,0xFC,0x11,0x04,0x11,0x00,0x11,0xC0,0x11,0x30,0x0E,0x0C,0x00,0x04},/*"R",50*/
{0x00,0x00,0x0E,0x1C,0x11,0x04,0x10,0x84,0x10,0x84,0x10,0x44,0x1C,0x38,0x00,0x00},/*"S",51*/
{0x18,0x00,0x10,0x00,0x10,0x04,0x1F,0xFC,0x10,0x04,0x10,0x00,0x18,0x00,0x00,0x00},/*"T",52*/
{0x10,0x00,0x1F,0xF8,0x10,0x04,0x00,0x04,0x00,0x04,0x10,0x04,0x1F,0xF8,0x10,0x00},/*"U",53*/
{0x10,0x00,0x1E,0x00,0x11,0xE0,0x00,0x1C,0x00,0x70,0x13,0x80,0x1C,0x00,0x10,0x00},/*"V",54*/
{0x1F,0xC0,0x10,0x3C,0x00,0xE0,0x1F,0x00,0x00,0xE0,0x10,0x3C,0x1F,0xC0,0x00,0x00},/*"W",55*/
{0x10,0x04,0x18,0x0C,0x16,0x34,0x01,0xC0,0x01,0xC0,0x16,0x34,0x18,0x0C,0x10,0x04},/*"X",56*/
{0x10,0x00,0x1C,0x00,0x13,0x04,0x00,0xFC,0x13,0x04,0x1C,0x00,0x10,0x00,0x00,0x00},/*"Y",57*/
{0x08,0x04,0x10,0x1C,0x10,0x64,0x10,0x84,0x13,0x04,0x1C,0x04,0x10,0x18,0x00,0x00},/*"Z",58*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFE,0x40,0x02,0x40,0x02,0x40,0x02,0x00,0x00},/*"[",59*/
{0x00,0x00,0x30,0x00,0x0C,0x00,0x03,0x80,0x00,0x60,0x00,0x1C,0x00,0x03,0x00,0x00},/*"\",60*/
{0x00,0x00,0x40,0x02,0x40,0x02,0x40,0x02,0x7F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00},/*"]",61*/
{0x00,0x00,0x00,0x00,0x20,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x00,0x00},/*"^",62*/
{0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01,0x00,0x01},/*"_",63*/
{0x00,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"`",64*/
{0x00,0x00,0x00,0x98,0x01,0x24,0x01,0x44,0x01,0x44,0x01,0x44,0x00,0xFC,0x00,0x04},/*"a",65*/
{0x10,0x00,0x1F,0xFC,0x00,0x88,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x70,0x00,0x00},/*"b",66*/
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x00},/*"c",67*/
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x11,0x08,0x1F,0xFC,0x00,0x04},/*"d",68*/
{0x00,0x00,0x00,0xF8,0x01,0x44,0x01,0x44,0x01,0x44,0x01,0x44,0x00,0xC8,0x00,0x00},/*"e",69*/
{0x00,0x00,0x01,0x04,0x01,0x04,0x0F,0xFC,0x11,0x04,0x11,0x04,0x11,0x00,0x18,0x00},/*"f",70*/
{0x00,0x00,0x00,0xD6,0x01,0x29,0x01,0x29,0x01,0x29,0x01,0xC9,0x01,0x06,0x00,0x00},/*"g",71*/
{0x10,0x04,0x1F,0xFC,0x00,0x84,0x01,0x00,0x01,0x00,0x01,0x04,0x00,0xFC,0x00,0x04},/*"h",72*/
{0x00,0x00,0x01,0x04,0x19,0x04,0x19,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"i",73*/
{0x00,0x00,0x00,0x03,0x00,0x01,0x01,0x01,0x19,0x01,0x19,0xFE,0x00,0x00,0x00,0x00},/*"j",74*/
{0x10,0x04,0x1F,0xFC,0x00,0x24,0x00,0x40,0x01,0xB4,0x01,0x0C,0x01,0x04,0x00,0x00},/*"k",75*/
{0x00,0x00,0x10,0x04,0x10,0x04,0x1F,0xFC,0x00,0x04,0x00,0x04,0x00,0x00,0x00,0x00},/*"l",76*/
{0x01,0x04,0x01,0xFC,0x01,0x04,0x01,0x00,0x01,0xFC,0x01,0x04,0x01,0x00,0x00,0xFC},/*"m",77*/
{0x01,0x04,0x01,0xFC,0x00,0x84,0x01,0x00,0x01,0x00,0x01,0x04,0x00,0xFC,0x00,0x04},/*"n",78*/
{0x00,0x00,0x00,0xF8,0x01,0x04,0x01,0x04,0x01,0x04,0x01,0x04,0x00,0xF8,0x00,0x00},/*"o",79*/
{0x01,0x01,0x01,0xFF,0x00,0x85,0x01,0x04,0x01,0x04,0x00,0x88,0x00,0x70,0x00,0x00},/*"p",80*/
{0x00,0x00,0x00,0x70,0x00,0x88,0x01,0x04,0x01,0x04,0x01,0x05,0x01,0xFF,0x00,0x01},/*"q",81*/
{0x01,0x04,0x01,0x04,0x01,0xFC,0x00,0x84,0x01,0x04,0x01,0x00,0x01,0x80,0x00,0x00},/*"r",82*/
{0x00,0x00,0x00,0xCC,0x01,0x24,0x01,0x24,0x01,0x24,0x01,0x24,0x01,0x98,0x00,0x00},/*"s",83*/
{0x00,0x00,0x01,0x00,0x01,0x00,0x07,0xF8,0x01,0x04,0x01,0x04,0x00,0x00,0x00,0x00},/*"t",84*/
{0x01,0x00,0x01,0xF8,0x00,0x04,0x00,0x04,0x00,0x04,0x01,0x08,0x01,0xFC,0x00,0x04},/*"u",85*/
{0x01,0x00,0x01,0x80,0x01,0x70,0x00,0x0C,0x00,0x10,0x01,0x60,0x01,0x80,0x01,0x00},/*"v",86*/
{0x01,0xF0,0x01,0x0C,0x00,0x30,0x01,0xC0,0x00,0x30,0x01,0x0C,0x01,0xF0,0x01,0x00},/*"w",87*/
{0x00,0x00,0x01,0x04,0x01,0x8C,0x00,0x74,0x01,0x70,0x01,0x8C,0x01,0x04,0x00,0x00},/*"x",88*/
{0x01,0x01,0x01,0x81,0x01,0x71,0x00,0x0E,0x00,0x18,0x01,0x60,0x01,0x80,0x01,0x00},/*"y",89*/
{0x00,0x00,0x01,0x84,0x01,0x0C,0x01,0x34,0x01,0x44,0x01,0x84,0x01,0x0C,0x00,0x00},/*"z",90*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x3E,0xFC,0x40,0x02,0x40,0x02},/*"{",91*/
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00},/*"|",92*/
{0x00,0x00,0x40,0x02,0x40,0x02,0x3E,0xFC,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"}",93*/
{0x00,0x00,0x60,0x00,0x80,0x00,0x80,0x00,0x40,0x00,0x40,0x00,0x20,0x00,0x20,0x00},/*"~",94*/
};

void oled_i2c_master_gpio_init(void)
{
	portENTER_CRITICAL();
//    ETS_INTR_LOCK();

    PIN_FUNC_SELECT(I2C_MASTER_SDA_MUX, I2C_MASTER_SDA_FUNC);
    PIN_FUNC_SELECT(I2C_MASTER_SCL_MUX, I2C_MASTER_SCL_FUNC);

    GPIO_REG_WRITE(GPIO_PIN_ADDR(GPIO_ID_PIN(I2C_MASTER_SDA_GPIO)), GPIO_REG_READ(GPIO_PIN_ADDR(GPIO_ID_PIN(I2C_MASTER_SDA_GPIO))) | GPIO_PIN_PAD_DRIVER_SET(GPIO_PAD_DRIVER_ENABLE)); //open drain;
    GPIO_REG_WRITE(GPIO_ENABLE_ADDRESS, GPIO_REG_READ(GPIO_ENABLE_ADDRESS) | (1 << I2C_MASTER_SDA_GPIO));
    GPIO_REG_WRITE(GPIO_PIN_ADDR(GPIO_ID_PIN(I2C_MASTER_SCL_GPIO)), GPIO_REG_READ(GPIO_PIN_ADDR(GPIO_ID_PIN(I2C_MASTER_SCL_GPIO))) | GPIO_PIN_PAD_DRIVER_SET(GPIO_PAD_DRIVER_ENABLE)); //open drain;
    GPIO_REG_WRITE(GPIO_ENABLE_ADDRESS, GPIO_REG_READ(GPIO_ENABLE_ADDRESS) | (1 << I2C_MASTER_SCL_GPIO));

    I2C_MASTER_SDA_HIGH_SCL_HIGH();

    portEXIT_CRITICAL();
//    ETS_INTR_UNLOCK();

//    i2c_master_init();
}
/******************************************************************************
 * FunctionName : oled_i2c_master_setDC
 * Description  : Internal used function -
 *                    set i2c SDA and SCL bit value for half clk cycle
 * Parameters   : uint8 SDA
 *                uint8 SCL
 * Returns      : NONE
*******************************************************************************/
LOCAL void ICACHE_FLASH_ATTR
oled_i2c_master_setDC(uint8 SDA, uint8 SCL)
{
    SDA	&= 0x01;
    SCL	&= 0x01;
    m_nLastSDA = SDA;
    m_nLastSCL = SCL;

    if ((0 == SDA) && (0 == SCL)) {
        I2C_MASTER_SDA_LOW_SCL_LOW();
    } else if ((0 == SDA) && (1 == SCL)) {
        I2C_MASTER_SDA_LOW_SCL_HIGH();
    } else if ((1 == SDA) && (0 == SCL)) {
        I2C_MASTER_SDA_HIGH_SCL_LOW();
    } else {
        I2C_MASTER_SDA_HIGH_SCL_HIGH();
    }
}

/******************************************************************************
 * FunctionName : i2c_master_getDC
 * Description  : Internal used function -
 *                    get i2c SDA bit value
 * Parameters   : NONE
 * Returns      : uint8 - SDA bit value
*******************************************************************************/
LOCAL uint8 ICACHE_FLASH_ATTR
oled_i2c_master_getDC(void)
{
    uint8 sda_out;
    sda_out = GPIO_INPUT_GET(GPIO_ID_PIN(I2C_MASTER_SDA_GPIO));
    return sda_out;
}

/******************************************************************************
 * FunctionName : oled_i2c_master_start
 * Description  : set i2c to send state
 * Parameters   : NONE
 * Returns      : NONE
 *    SCL = high;
   Delay_1ms(1);
   SDA = high;
   Delay_1ms(1);
   SDA = low;
  Delay_1ms(1);
   SCL = low;
  Delay_1ms(1);
*******************************************************************************/
LOCAL void ICACHE_FLASH_ATTR
oled_i2c_master_start(void)
{
	oled_i2c_master_setDC(1, m_nLastSCL);
    i2c_master_wait(5);
    oled_i2c_master_setDC(1, 1);
    i2c_master_wait(5);	// sda 1, scl 1
    oled_i2c_master_setDC(0, 1);
    i2c_master_wait(5);	// sda 0, scl 1
}
/******************************************************************************
 * FunctionName : i2c_master_stop
 * Description  : set i2c to stop sending state
 * Parameters   : NONE
 * Returns      : NONE
 *    SCL = low;
   Delay_1ms(1);
   SDA = low;
   Delay_1ms(1);
   SCL = high;
   Delay_1ms(1);
   SDA = high;
   Delay_1ms(1);
*******************************************************************************/
LOCAL void ICACHE_FLASH_ATTR
oled_i2c_master_stop(void)
{
    i2c_master_wait(5);

    oled_i2c_master_setDC(0, m_nLastSCL);
    i2c_master_wait(5);	// sda 0
    oled_i2c_master_setDC(0, 1);
    i2c_master_wait(5);	// sda 0, scl 1
    oled_i2c_master_setDC(1, 1);
    i2c_master_wait(5);	// sda 1, scl 1
}

/******************************************************************************
 * FunctionName : i2c_master_getAck
 * Description  : confirm if peer send ack
 * Parameters   : NONE
 * Returns      : uint8 - ack value, 0 or 1
*******************************************************************************/
uint8 ICACHE_FLASH_ATTR
oled_i2c_master_getAck(void)
{
    uint8 retVal;
    oled_i2c_master_setDC(m_nLastSDA, 0);
    i2c_master_wait(5);
    oled_i2c_master_setDC(1, 0);
    i2c_master_wait(5);
    oled_i2c_master_setDC(1, 1);
    i2c_master_wait(5);

    retVal = oled_i2c_master_getDC();
    i2c_master_wait(5);
    oled_i2c_master_setDC(1, 0);
    i2c_master_wait(5);

    return retVal;
}

/******************************************************************************
 * FunctionName : i2c_master_writeByte
 * Description  : write wrdata value(one byte) into i2c
 * Parameters   : uint8 wrdata - write value
 * Returns      : NONE
 *
 * 	unsigned char i;
	for(i=0;i<8;i++)
	{
		if(IIC_Byte & 0x80)		//1?0?
		{

		SDA=high;
		}
		else
		{

		SDA=low;
		}
	Delay_1ms(1);
		SCL=high;
	Delay_1ms(1);
		SCL=low;
	Delay_1ms(1);
		IIC_Byte<<=1;			//loop
	}
	SDA=1;
Delay_1ms(1);
	SCL=1;
Delay_1ms(1);
	SCL=0;
Delay_1ms(1);
*******************************************************************************/
LOCAL void ICACHE_FLASH_ATTR
oled_i2c_master_writeByte(uint8 wrdata)
{
    uint8 dat;
    sint8 i;

    i2c_master_wait(1000);

    oled_i2c_master_setDC(m_nLastSDA, 0);
    i2c_master_wait(5);

    for (i = 7; i >= 0; i--) {
        dat = wrdata >> i;
        oled_i2c_master_setDC(dat, 0);
        i2c_master_wait(5);
        oled_i2c_master_setDC(dat, 1);
        i2c_master_wait(5);

        if (i == 0) {
            i2c_master_wait(5);   ////
        }

        oled_i2c_master_setDC(dat, 0);
        i2c_master_wait(5);
    }
    oled_i2c_master_getAck();
}

/**********************************************
// IIC Write Command
**********************************************/
LOCAL void ICACHE_FLASH_ATTR
oled_write_i2c_command(unsigned char IIC_Command)
{
	oled_i2c_master_start();
	oled_i2c_master_writeByte(0x78);            //Slave address,SA0=0
	oled_i2c_master_writeByte(0x00);			//write command
	oled_i2c_master_writeByte(IIC_Command);
	oled_i2c_master_stop();
}



/**********************************************
// IIC Write Data
**********************************************/
void ICACHE_FLASH_ATTR
ole_write_i2c_data(unsigned char IIC_Data)
{
	oled_i2c_master_start();
	oled_i2c_master_writeByte(0x78);			//D/C#=0; R/W#=0
	oled_i2c_master_writeByte(0x40);			//write data
	oled_i2c_master_writeByte(IIC_Data);
	oled_i2c_master_stop();
}

void ICACHE_FLASH_ATTR
Initial_M096128x64_ssd1306()
{
	oled_write_i2c_command(0xAE);   //display off
	oled_write_i2c_command(0x20);	//Set Memory Addressing Mode
	oled_write_i2c_command(0x10);	//00,Horizontal Addressing Mode;01,Vertical Addressing Mode;10,Page Addressing Mode (RESET);11,Invalid
	oled_write_i2c_command(0xb0);	//Set Page Start Address for Page Addressing Mode,0-7
	oled_write_i2c_command(0xc8);	//Set COM Output Scan Direction
	oled_write_i2c_command(0x00);//---set low column address
	oled_write_i2c_command(0x10);//---set high column address
	oled_write_i2c_command(0x40);//--set start line address
	oled_write_i2c_command(0x81);//--set contrast control register
	oled_write_i2c_command(0xdf);
	oled_write_i2c_command(0xa1);//--set segment re-map 0 to 127
	oled_write_i2c_command(0xa6);//--set normal display
	oled_write_i2c_command(0xa8);//--set multiplex ratio(1 to 64)
	oled_write_i2c_command(0x3F);//
	oled_write_i2c_command(0xa4);//0xa4,Output follows RAM content;0xa5,Output ignores RAM content
	oled_write_i2c_command(0xd3);//-set display offset
	oled_write_i2c_command(0x00);//-not offset
	oled_write_i2c_command(0xd5);//--set display clock divide ratio/oscillator frequency
	oled_write_i2c_command(0xf0);//--set divide ratio
	oled_write_i2c_command(0xd9);//--set pre-charge period
	oled_write_i2c_command(0x22); //
	oled_write_i2c_command(0xda);//--set com pins hardware configuration
	oled_write_i2c_command(0x12);
	oled_write_i2c_command(0xdb);//--set vcomh
	oled_write_i2c_command(0x20);//0x20,0.77xVcc
	oled_write_i2c_command(0x8d);//--set DC-DC enable
	oled_write_i2c_command(0x14);//
	oled_write_i2c_command(0xaf);//--turn on oled panel
}
/**********************************************
// Refresh Gram
**********************************************/
void ICACHE_FLASH_ATTR
oled_refresh_Gram()//u8 line
{
	uint8 i,n;
	oled_i2c_master_start();
	oled_write_i2c_command(0xA1); // Remap
	for(i=0;i<8;i++)
	{
		oled_write_i2c_command (0xb0+i);//+(line-1)*2);//ÉèÖÃÒ³µØÖ·£¨0~7£©
		oled_write_i2c_command (0x0); //ÉèÖÃÏÔÊ¾Î»ÖÃ¡ªÁÐµÍµØÖ·,Æ«ÒÆÁË2ÁÐ
		oled_write_i2c_command (0x10); //ÉèÖÃÏÔÊ¾Î»ÖÃ¡ªÁÐ¸ßµØÖ·
		for(n=0;n<128;n++)
			ole_write_i2c_data(OLED_GRAM[n][i]);
	}
	oled_i2c_master_stop();
}

//--------------------------------------------------------------
// Prototype : void oled_display_On()
// Calls :
// Parameters :
// Description : ¿ªÆôOLEDÏÔÊ¾
//--------------------------------------------------------------
void ICACHE_FLASH_ATTR
oled_display_On(void)
{
	oled_write_i2c_command(0X8D); //SET DCDCÃüÁî
	oled_write_i2c_command(0X14); //DCDC ON
	oled_write_i2c_command(0XAF); //DISPLAY ON
}
//-------------------------------------------------------------
// Prototype : void oled_display_Off()
// Calls :
// Parameters :
// Description : ¹Ø±ÕOLEDÏÔÊ¾
//--------------------------------------------------------------
void ICACHE_FLASH_ATTR
oled_display_Off(void)
{
	oled_write_i2c_command(0X8D); //SET DCDCÃüÁî
	oled_write_i2c_command(0X10); //DCDC OFF
	oled_write_i2c_command(0XAE); //DISPLAY OFF
}

//--------------------------------------------------------------
// Prototype : void OLED_Clear()
// Calls :
// Parameters :
// Description : ÇåÆÁº¯Êý,ÇåÍêÆÁ,Õû¸öÆÁÄ»ÊÇºÚÉ«µÄ!ºÍÃ»µãÁÁÒ»Ñù!!!
//--------------------------------------------------------------
void ICACHE_FLASH_ATTR
oled_clear(void)
{
	uint8 i,n;

	oled_write_i2c_command(0xA1); // Remap
	for(i=0;i<8;i++)
	{
		oled_write_i2c_command (0xb0+i);//ÉèÖÃÒ³µØÖ·£¨0~7£©
		oled_write_i2c_command (0x0); //ÉèÖÃÏÔÊ¾Î»ÖÃ¡ªÁÐµÍµØÖ·,Æ«ÒÆÁË2ÁÐ
		oled_write_i2c_command (0x10); //ÉèÖÃÏÔÊ¾Î»ÖÃ¡ªÁÐ¸ßµØÖ·
		for(n=0;n<128;n++)
			ole_write_i2c_data(0x00);
		}
	oled_i2c_master_stop();
}

//--------------------------------------------------------------
// Prototype : void OLED_DrawPoint(u8 x,u8 y,u8 t)
// Calls :
// Parameters : x:0~127,y:0~15,t:1 Ìî³ä 0,Çå¿Õ
// Description : »­µã
//--------------------------------------------------------------
void ICACHE_FLASH_ATTR
oled_drawPoint(u8 x,u8 y,u8 t)
{
	uint8 pos,bx,temp=0;
	if(x>127||y>63)return;//³¬³ö·¶Î§ÁË.
	pos=y/8;// 0/1
	bx=y%8;
	temp=1<<bx;
	if(t)OLED_GRAM[x][pos]|=temp;
	else OLED_GRAM[x][pos]&=~temp;
}
//--------------------------------------------------------------
// Prototype : void OLED_ShowChar(u8 x,u8 y,u8 chr,u8 size,u8 mode)
// Calls :
// Parameters : x:0~127,y:0~15,mode:0,·´°×ÏÔÊ¾;1,Õý³£ÏÔÊ¾
// size:Ñ¡Ôñ×ÖÌå 16/12
// Description : show a char in a position
//--------------------------------------------------------------
void ICACHE_FLASH_ATTR
oled_showChar(u8 x,u8 y,u8 chr,u8 size,u8 mode)
{
	uint8 temp,t,t1;
	uint8 y0=y;
	chr=chr-' ' ;//µÃµ½Æ«ÒÆºóµÄÖµ
	for(t=0;t<size;t++)
	{
		temp=asc2_1608[chr][t]; //µ÷ÓÃ1608×ÖÌå
		for(t1=0;t1<8;t1++)
		{
			if(temp&0x80)oled_drawPoint(x,y,mode);
			else oled_drawPoint(x,y,!mode);
			temp<<=1;
			y++;
			if((y-y0)==size)
			{
				y=y0;
				x++;
				break;
			}
		}
	}
}
//--------------------------------------------------------------
// Prototype : void OLED_ShowString(u8 x,u8 y,const u8 *p)
// Calls :
// Parameters : x,y :Æðµã×ø±ê
// *p:×Ö·û´®ÆðÊ¼µØÖ·,ÓÃ16×ÖÌå
// Description : ÏÔÊ¾×Ö·û´®
//--------------------------------------------------------------
void ICACHE_FLASH_ATTR
oled_showString(u8 x,u8 y,const u8 *p)
{
	#define MAX_CHAR_POSX 120
	#define MAX_CHAR_POSY 48
	while(*p!='\0')
	{
		if(x>MAX_CHAR_POSX){x=0;y+=16;}
		if(y>MAX_CHAR_POSY){y=x=0;}//sOLED_Clear(); OLED_ShowChar(x,y,*p,16,1);
		x+=8;
		p++;
	}
}
